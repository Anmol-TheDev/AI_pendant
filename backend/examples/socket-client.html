<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO Chat Test Client</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 600px;
            height: 700px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .chat-header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .chat-header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .connection-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        .connection-status.disconnected {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9fafb;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.system .message-content {
            background: white;
            color: #1f2937;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 4px;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            border: 1px solid #e5e7eb;
            max-width: 70%;
            margin-bottom: 15px;
        }

        .typing-indicator span {
            height: 8px;
            width: 8px;
            background: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        .streaming-message {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 70%;
            margin-bottom: 15px;
            border-bottom-left-radius: 4px;
            white-space: pre-wrap;
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
        }

        .input-container input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .input-container input:focus {
            border-color: #667eea;
        }

        .input-container button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .input-container button:hover {
            transform: scale(1.05);
        }

        .input-container button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(1);
        }

        .auth-form {
            padding: 20px;
            background: white;
        }

        .auth-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .auth-form button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>ðŸ§ª Socket.IO Test Client</h1>
            <p>
                <span class="connection-status" id="status"></span>
                <span id="statusText">Disconnected</span>
            </p>
        </div>

        <div id="authForm" class="auth-form">
            <h3 style="margin-bottom: 15px;">Connect to Backend</h3>
            <div id="authError" class="error-message" style="display: none;"></div>
            <input type="text" id="serverUrl" placeholder="Server URL" value="http://localhost:4000" />
            <input type="text" id="usernameInput" placeholder="Your Name (optional)" />
            <button onclick="connect()">Connect</button>
            <p style="margin-top: 15px; font-size: 12px; color: #6b7280;">
                This is a test client for the backend Socket.IO server.<br>
                No authentication required - just connect and start chatting!
            </p>
        </div>

        <div id="chatInterface" style="display: none; flex: 1; display: flex; flex-direction: column;">
            <div class="messages-container" id="messages"></div>
            <div class="input-container">
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="Ask me anything..." 
                    onkeypress="handleKeyPress(event)"
                />
                <button onclick="sendMessage()" id="sendBtn">Send</button>
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let streamingText = '';
        let username = '';

        function connect() {
            const serverUrl = document.getElementById('serverUrl').value.trim();
            username = document.getElementById('usernameInput').value.trim() || 'Anonymous';

            if (!serverUrl) {
                showError('Please enter server URL');
                return;
            }

            // Connect to Socket.IO (no auth required)
            socket = io(serverUrl);

            socket.on('connect', () => {
                console.log('Connected to chat');
                updateStatus(true);
                document.getElementById('authForm').style.display = 'none';
                document.getElementById('chatInterface').style.display = 'flex';
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from chat');
                updateStatus(false);
            });

            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
                showError('Connection failed: ' + error.message);
                updateStatus(false);
            });

            socket.on('chatroom:joined', (data) => {
                console.log('Joined chatroom:', data.chatroom);
                displayMessages(data.messages.reverse());
            });

            socket.on('message:received', (message) => {
                addMessage(message);
            });

            socket.on('ai:typing', (data) => {
                if (data.isTyping) {
                    showTypingIndicator();
                } else {
                    hideTypingIndicator();
                }
            });

            socket.on('ai:streaming', (data) => {
                if (data.isComplete) {
                    hideStreamingMessage();
                    streamingText = '';
                } else {
                    streamingText += data.chunk;
                    updateStreamingMessage(streamingText);
                }
            });

            socket.on('error', (error) => {
                console.error('Socket error:', error);
                alert('Error: ' + error.message);
            });
        }

        function updateStatus(connected) {
            const status = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                status.classList.remove('disconnected');
                statusText.textContent = 'Connected';
            } else {
                status.classList.add('disconnected');
                statusText.textContent = 'Disconnected';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function displayMessages(messages) {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            messages.forEach(msg => addMessage(msg));
        }

        function addMessage(message) {
            const container = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.messageType}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = message.content;
            
            messageDiv.appendChild(contentDiv);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function showTypingIndicator() {
            const container = document.getElementById('messages');
            const existing = document.getElementById('typingIndicator');
            if (existing) return;

            const indicator = document.createElement('div');
            indicator.id = 'typingIndicator';
            indicator.className = 'typing-indicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            container.appendChild(indicator);
            container.scrollTop = container.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        function updateStreamingMessage(text) {
            const container = document.getElementById('messages');
            let streamingDiv = document.getElementById('streamingMessage');
            
            if (!streamingDiv) {
                hideTypingIndicator();
                streamingDiv = document.createElement('div');
                streamingDiv.id = 'streamingMessage';
                streamingDiv.className = 'streaming-message';
                container.appendChild(streamingDiv);
            }
            
            streamingDiv.textContent = text;
            container.scrollTop = container.scrollHeight;
        }

        function hideStreamingMessage() {
            const streamingDiv = document.getElementById('streamingMessage');
            if (streamingDiv) streamingDiv.remove();
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !socket) return;
            
            socket.emit('message:send', { content, username });
            input.value = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
    </script>
</body>
</html>
