meta {
  name: Enter Chatroom
  type: http
  seq: 6
}

post {
  url: {{baseUrl}}/api/chatrooms/6967cb20036951bf7420593a/enter
  body: json
  auth: none
}

headers {
  Content-Type: application/json
}

body:json {
  {
    "userId": "507f1f77bcf86cd799439011",
    "message": "What did I talk about today?"
  }
}

vars:pre-request {
  baseUrl: http://localhost:4000
}

docs {
  # Enter Chatroom with Transcript Context
  
  This endpoint allows you to enter a chatroom and automatically loads the transcript context from that day. The AI assistant (Gemini) will be initialized with the transcript context and instructed to answer questions ONLY based on that context.
  
  ## Key Features
  
  - **Context-Aware AI**: Gemini receives the full transcript context for the day
  - **Boundary Enforcement**: AI is instructed to stay within the provided context
  - **Optional First Message**: You can send a message immediately upon entering
  - **Context Summary**: Returns statistics about the available transcript context
  
  ## Path Parameters
  
  - **chatroomId** (required) - MongoDB ObjectId of the chatroom
    - Example: `679c1234567890abcdef1234`
  
  ## Request Body
  
  ```json
  {
    "userId": "507f1f77bcf86cd799439011",
    "message": "What did I talk about today?"
  }
  ```
  
  ### Fields
  
  - **userId** (optional) - User ID to fetch transcript context for
    - **MUST be a valid MongoDB ObjectId** (24 hex characters)
    - If omitted, chatroom is entered without transcript context
    - If invalid format, transcript context will be skipped (no error thrown)
    - Type: `string` (MongoDB ObjectId format)
    - Example: `"507f1f77bcf86cd799439011"` or `"6967cb20036951bf7420593a"`
  
  - **message** (optional) - First message to send upon entering
    - If provided, AI will respond immediately with context-aware answer
    - If omitted, just returns chatroom info and context summary
    - Type: `string`
    - Example: `"What did I talk about today?"`
  
  ## Response
  
  ### Success Response (200) - With Context and Message
  
  ```json
  {
    "success": true,
    "message": "Successfully fetched Chatroom.",
    "data": {
      "chatroom": {
        "id": "679c1234567890abcdef1234",
        "name": "Daily Chat - 2026-01-17",
        "description": "Chatroom for 2026-01-17",
        "date": "2026-01-17T00:00:00.000Z",
        "isActive": true,
        "stats": {
          "totalMessages": 15,
          "lastMessageAt": "2026-01-17T14:30:00.000Z"
        }
      },
      "context": {
        "hasContext": true,
        "totalChunks": 45,
        "totalWords": 3250,
        "timeRange": {
          "start": "2026-01-17T00:00:00.000Z",
          "end": "2026-01-18T00:00:00.000Z"
        }
      },
      "systemPrompt": "Context-aware mode: AI will answer based on transcript context only",
      "aiResponse": "Based on your transcript today, you discussed several topics including your morning meeting about the Q1 project deadline, a conversation about the new marketing strategy at lunch, and your afternoon focus session on coding the authentication module. You also mentioned feeling productive and accomplished today."
    }
  }
  ```
  
  ### Success Response (200) - Without Context
  
  ```json
  {
    "success": true,
    "message": "Successfully fetched Chatroom.",
    "data": {
      "chatroom": {
        "id": "679c1234567890abcdef1234",
        "name": "Daily Chat - 2026-01-17",
        "description": "Chatroom for 2026-01-17",
        "date": "2026-01-17T00:00:00.000Z",
        "isActive": true,
        "stats": {
          "totalMessages": 0
        }
      },
      "context": {
        "hasContext": false,
        "totalChunks": 0,
        "totalWords": 0
      },
      "systemPrompt": "General conversation mode",
      "aiResponse": null
    }
  }
  ```
  
  ### Error Response (404)
  
  ```json
  {
    "success": false,
    "message": "Chatroom not found"
  }
  ```
  
  ## How It Works
  
  ### 1. Context Loading
  
  When you enter a chatroom with a `userId`:
  
  1. System finds the chatroom by ID
  2. Looks for transcript data from the same date
  3. Retrieves all transcript chunks organized by hour
  4. Builds a structured context document
  
  ### 2. AI Initialization
  
  Gemini receives a system prompt like:
  
  ```
  You are a helpful AI assistant in a daily chatroom.
  
  IMPORTANT INSTRUCTIONS:
  - You have access to the user's transcript context from this day
  - Answer questions ONLY based on the provided transcript context
  - If the user asks about something not in the transcript, politely say you don't have that information in today's context
  - Do NOT make up information or go outside the provided context
  - You can summarize, analyze, and answer questions about the transcript content
  - Be helpful and conversational while staying within the context boundaries
  
  # Transcript Context for Daily Chat - 2026-01-17
  
  Date: 2026-01-17
  Transcript Period: Day 5 (2026-01-17T00:00:00.000Z to 2026-01-18T00:00:00.000Z)
  
  ## Hour 9:00
  
  [09:15] Had a productive morning meeting with the team about Q1 deadlines
  [09:45] Discussed the new authentication module requirements
  
  ## Hour 10:00
  
  [10:30] Started coding the login flow
  [10:55] Implemented JWT token generation
  
  ...
  ```
  
  ### 3. Context Boundaries
  
  The AI is explicitly instructed to:
  
  - ✅ Answer questions about events in the transcript
  - ✅ Summarize and analyze transcript content
  - ✅ Find patterns and insights from the day
  - ✅ Quote or reference specific transcript chunks
  - ❌ Make up information not in the transcript
  - ❌ Answer questions about other days
  - ❌ Provide general knowledge outside the context
  
  ## Use Cases
  
  ### 1. Daily Review
  
  ```json
  {
    "userId": "507f1f77bcf86cd799439011",
    "message": "Summarize my day"
  }
  ```
  
  ### 2. Specific Query
  
  ```json
  {
    "userId": "507f1f77bcf86cd799439011",
    "message": "What did I say about the project deadline?"
  }
  ```
  
  ### 3. Time-Based Query
  
  ```json
  {
    "userId": "507f1f77bcf86cd799439011",
    "message": "What was I doing around 2pm?"
  }
  ```
  
  ### 4. Topic Search
  
  ```json
  {
    "userId": "507f1f77bcf86cd799439011",
    "message": "Did I mention anything about the marketing meeting?"
  }
  ```
  
  ### 5. Just Enter (No Message)
  
  ```json
  {
    "userId": "507f1f77bcf86cd799439011"
  }
  ```
  
  Returns context info without generating AI response.
  
  ## Context Summary Fields
  
  - **hasContext** - Boolean indicating if transcript context was found
  - **totalChunks** - Number of transcript chunks available
  - **totalWords** - Total word count across all chunks
  - **timeRange** - Start and end time of the transcript period
  
  ## Example Workflow
  
  ### Step 1: Enter Chatroom
  
  ```bash
  POST /api/chatrooms/679c1234567890abcdef1234/enter
  {
    "userId": "507f1f77bcf86cd799439011",
    "message": "What did I accomplish today?"
  }
  ```
  
  ### Step 2: AI Responds with Context
  
  AI analyzes the transcript and responds:
  
  > "Based on your transcript, you accomplished several things today:
  > 1. Completed the authentication module (mentioned at 10:55)
  > 2. Had a successful team meeting about Q1 deadlines (9:15)
  > 3. Reviewed the marketing strategy (12:30)
  > 4. Fixed 3 bugs in the payment system (15:20)"
  
  ### Step 3: Continue Conversation
  
  Use Socket.IO or regular message endpoints to continue the conversation. The AI maintains the context throughout the session.
  
  ## Integration with Socket.IO
  
  After entering via this endpoint, you can:
  
  1. Connect to Socket.IO
  2. Join the chatroom: `socket.emit('chatroom:join', { chatroomId })`
  3. Send messages: `socket.emit('message:send', { content })`
  4. AI will continue using the transcript context
  
  ## Performance Notes
  
  - Context loading is optimized with indexed queries
  - Large transcripts (1000+ chunks) are handled efficiently
  - Context is built on-demand, not cached
  - Typical response time: 200-500ms for context loading
  - AI response time: 1-3 seconds depending on message complexity
  
  ## Limitations
  
  - Context is limited to the specific day's transcript
  - No cross-day context (by design)
  - AI cannot access external information
  - Maximum context size: ~100,000 words (Gemini limit)
  
  ## Related Endpoints
  
  - Get messages: `GET /api/chatrooms/:id/messages`
  - Get paginated messages: `GET /api/chatrooms/:id/messages/paginated`
  - Get transcript context: `GET /api/transcripts/context/daily/:userId/:dayNumber`
  - Socket.IO chat: `ws://localhost:4000` (see Socket.IO docs)
  
  ## Tips
  
  1. **Always provide userId** if you want context-aware responses
  2. **Use valid MongoDB ObjectId format** for userId (24 hex characters)
  3. **Ask specific questions** for better AI responses
  4. **Use time references** ("this morning", "around 3pm") for time-based queries
  5. **Request summaries** to get overviews of the day
  6. **Check context.hasContext** to know if transcript data is available
  
  ## Important Notes
  
  - **userId Format**: Must be a valid MongoDB ObjectId (24 hexadecimal characters)
    - ✅ Valid: `"507f1f77bcf86cd799439011"`, `"6967cb20036951bf7420593a"`
    - ❌ Invalid: `"user123"`, `"abc"`, `"12345"`
  - If userId is invalid, the API will gracefully skip transcript context (no error)
  - The chatroom date is matched against transcript chatroom time ranges
  - Transcript context is loaded fresh on each request (not cached)
}
